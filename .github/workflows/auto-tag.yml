name: Auto Tag and Release on Release Merge

on:
  pull_request:
    branches:
      - main
    types: [closed]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  tag-release-backmerge:
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    # Run only when "merged" and "source branch starts with release/"
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract version from version.rb
        id: get_version
        run: |
          VERSION=$(grep -oP "VERSION\s*=\s*['\"]\\K[^'\"]+" lib/radvent/version.rb)
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract version from version.rb"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          REPOSITORY=$(echo ${{ github.repository }} | sed -e "s#.*/##")
          echo "REPOSITORY=$REPOSITORY" >> $GITHUB_ENV
          echo "FILENAME=$REPOSITORY-$VERSION" >> $GITHUB_ENV

      - name: Create and Push Tag
        run: |
          git checkout main
          if git rev-parse --verify "refs/tags/${{ env.VERSION }}" >/dev/null 2>&1; then
            echo "Tag ${{ env.VERSION }} already exists, skipping"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag "${{ env.VERSION }}"
            git push origin "${{ env.VERSION }}" || echo "Tag push failed, possibly already exists"
          fi

      - name: Create Archive
        run: |
          git archive --format=zip --prefix="${{ env.REPOSITORY }}/" "${{ env.VERSION }}" -o "${{ env.FILENAME }}.zip"

      - name: Create Release and Upload Asset
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "${{ env.VERSION }}" >/dev/null 2>&1; then
            echo "Release ${{ env.VERSION }} already exists, uploading asset with clobber"
            gh release upload "${{ env.VERSION }}" "${{ env.FILENAME }}.zip" --clobber
          else
            gh release create "${{ env.VERSION }}" \
              "${{ env.FILENAME }}.zip" \
              --title "${{ env.VERSION }}" \
              --prerelease
          fi

      - name: Create backmerge PR to develop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch develop to ensure it is available for comparison
          git fetch origin develop

          # Check if main is already merged into develop
          if git merge-base --is-ancestor origin/main origin/develop; then
            echo "main is already merged into develop, skipping PR creation"
            exit 0
          fi

          # Check if a backmerge PR already exists
          EXISTING_PR=$(gh pr list --base develop --head main --state open --json number --jq '.[0].number')
          if [ -n "$EXISTING_PR" ]; then
            echo "Backmerge PR #$EXISTING_PR already exists, skipping"
            exit 0
          fi

          # Create a new backmerge PR
          BODY="Automated backmerge of main to develop after release ${{ env.VERSION }}.

          This PR was created automatically by GitHub Actions."

          PR_URL=$(gh pr create \
            --base develop \
            --head main \
            --title "Backmerge main to develop (${{ env.VERSION }})" \
            --body "$BODY")

          # Add ignore-for-release label to the backmerge PR
          gh pr edit "$PR_URL" --add-label "ignore-for-release"

  build-amd64:
    needs: tag-release-backmerge
    if: ${{ needs.tag-release-backmerge.outputs.version != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Set version
        id: version
        run: |
          VERSION=${{ needs.tag-release-backmerge.outputs.version }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: Checkout
        uses: actions/checkout@v6
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push amd64 image
        env:
          RADVENT_VERSION: latest-amd64
        run: |
          docker compose build radvent
          docker compose push radvent
          docker tag ${{ env.IMAGE_NAME }}:latest-amd64 ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}-amd64
          docker push ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}-amd64

  build-arm64:
    needs: tag-release-backmerge
    if: ${{ needs.tag-release-backmerge.outputs.version != '' }}
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Set version
        id: version
        run: |
          VERSION=${{ needs.tag-release-backmerge.outputs.version }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: Checkout
        uses: actions/checkout@v6
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push arm64 image
        env:
          RADVENT_VERSION: latest-arm64
        run: |
          docker compose build radvent
          docker compose push radvent
          docker tag ${{ env.IMAGE_NAME }}:latest-arm64 ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}-arm64
          docker push ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}-arm64

  manifest:
    needs: [build-amd64, build-arm64]
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: haru/radvent
    steps:
      - name: Set version
        id: version
        run: |
          VERSION=${{ needs.build-amd64.outputs.version }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Create and push multi-arch manifest
        run: |
          docker manifest create ${{ env.IMAGE_NAME }}:latest \
            ${{ env.IMAGE_NAME }}:latest-amd64 \
            ${{ env.IMAGE_NAME }}:latest-arm64
          docker manifest push ${{ env.IMAGE_NAME }}:latest
          docker manifest create ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} \
            ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}-amd64 \
            ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}-arm64
          docker manifest push ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}

  update-description:
    needs: manifest
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: haru/radvent
    steps:
      - uses: actions/checkout@v6
      - name: Update Docker Hub description
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          repository: ${{ env.IMAGE_NAME }}
          readme-filepath: ./README.md
