# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Radvent is a Qiita-style Advent Calendar web application (Japanese-focused). Users can create events, publish markdown articles on specific calendar dates, and interact via likes and comments. Built with Ruby on Rails and Webpacker.

## Common Commands

### Setup
```bash
bundle install
yarn install
bundle exec rake radvent:generate_default_settings  # generates config/database.yml, config/secrets.yml, config/initializers/devise.yml
bundle exec rake db:create db:migrate
```

### Running the App
```bash
bundle exec rails s
```

### Testing
```bash
bundle exec rspec spec                         # run all tests
bundle exec rspec spec/models/                 # run model specs
bundle exec rspec spec/controllers/            # run controller specs
bundle exec rspec spec/models/user_spec.rb     # run a single spec file
bundle exec rspec spec/models/user_spec.rb:42  # run a specific test by line number
```

Coverage output goes to `coverage/` (HTML and LCOV formats).

### Asset Compilation
```bash
bundle exec rake assets:precompile
```

## Architecture

### Tech Stack
- **Backend**: Ruby (>= 3.0) / Rails, Puma, Devise (auth)
- **Frontend**: esbuild, HAML templates, PostCSS, Bootstrap 5 (mdb-ui-kit), @hotwired/stimulus
- **Markdown editor**: EasyMDE (easy-markdown-editor) with toolbar, side-by-side preview, image upload, and DOMPurify sanitization
- **Markdown**: Marked.js with highlight.js for syntax highlighting
- **File uploads**: CarrierWave
- **Database**: SQLite3 (dev default), MySQL 5.7+, or PostgreSQL (configurable via env vars in `config/database.yml`)

### Key Models and Relationships

```
Event ──< AdventCalendarItem >── User
               │
               └──1 Item ──< Comment
                      └──< Like >── User
```

- `User` — Devise-based auth, has admin role, has many items/likes/comments
- `Event` — Advent calendar event with start/end dates
- `AdventCalendarItem` — Calendar "slot" (date × event × user). The `date` column is **Integer** (1–31), not a Date type
- `Item` — Article with markdown body. `belongs_to :advent_calendar_item` (unique constraint)
- `Comment` — Has **no `user_id` column**; stores `user_name` as a string only
- `Like` — Belongs to user and item
- `Attachment` — File uploads via CarrierWave, belongs to `AdventCalendarItem`

### Routing Gotchas
- Event show route is **name-based**: `get 'events/:name'` → use `show_event_path(event.name)` (not `event_path(event)`)
- Items have nested `likes` resource and `preview` routes (both collection and member)
- Root points to `welcome#index`

### Layout Structure
- Admin pages use `layouts/admin`; public pages use `layouts/application`
- `EventsController` sets `layout 'admin'` but renders `show` with `layout: 'application'`

### Authorization Patterns
```ruby
before_action :authenticate_user!    # Devise login required
admin_user!                          # ApplicationController: renders 403 for non-admins
render_404 / render_403              # ApplicationController helpers
current_user.admin?                  # Admin check
```

### Configuration
- Timezone: Tokyo (`config.time_zone = 'Tokyo'`)
- Default locale: Japanese (`:ja`), with English support via `http_accept_language` gem
- App settings generated by `rake radvent:generate_default_settings` into `config/settings/`
- Default admin login: `admin@example.com` / `adminadmin`

## Code Style
- Ruby formatter: rufo with single quotes (`.rufo` config)
- Views are **HAML** (`.html.haml`) — never use ERB
- Generator config: RSpec with FactoryBot, controller specs enabled, view/helper/routing specs disabled
- HAML patterns:
  ```haml
  - content_for(:jumbotron) do
    %div.jumbotron= @event.title
  = render "partial", item: @item
  = t("views.events.show.some_key")
  ```

## Testing Conventions
- RSpec + FactoryBot (`create`/`build` can be called directly without prefix)
- Devise helpers: `sign_in @user` (via `Devise::Test::ControllerHelpers`, auto-included)
- Date mocking: `allow(Time.zone).to receive(:today).and_return(Date.new(2015, 12, 2))`
- Tests often call `Model.destroy_all` at the start of `before` blocks

## Docker
- `docker-compose.yml` at root runs PostgreSQL + Radvent
- `.devcontainer/` provides VS Code dev container setup with Ruby 3.1 and PostgreSQL
- Key env vars: `DB` (sqlite3/mysql/postgres), `DB_NAME`, `DB_USERNAME`, `DB_PASSWORD`, `DB_HOST`, `DB_PORT`, `RADVENT_TITLE`

## CI
GitHub Actions matrix tests against Ruby 3.0 & 3.1 with SQLite3, MySQL, and PostgreSQL.

## Active Technologies
- Ruby 3.x / Rails 8.1 / Node.js（esbuild） (001-remove-jquery-stimulus)
- N/A（データベース変更なし） (001-remove-jquery-stimulus)

## Recent Changes
- 001-remove-jquery-stimulus: Replaced jQuery with @hotwired/stimulus; esbuild replaces Webpacker; PostCSS replaces Sass/SCSS; simple-datatables replaces datatables.net-bs5
